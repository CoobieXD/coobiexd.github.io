var isMobile=$(window).width()<1200,dpi="300";$("body").removeClass("loading"),$("#write").prop("disabled",!1);var canvas=document.createElement("canvas"),sprites=[],sendText=function(){console.log("sendText");var t=$("#text").val();$.ajax({url:"//api0.coo.by/writer/list.php",type:"POST",data:{text:t},dataType:"json",success:function(t){loadSprites(t[0])}})},loadSprites=function(t){console.log("loadSprites");var e=Object.keys(t);if(e.every(t=>sprites.hasOwnProperty(t)))renderList(t);else for(var i=0,s=0;s<e.length;s++)if(sprites.hasOwnProperty(e[s]))++i>=e.length&&renderList(t);else{var n=new Image;n.src="./writer_core/cursives/kate/bitmaps/sprites/tiny/"+dpi+"dpi/"+e[s]+".png",n.onload=function(){++i>=e.length&&renderList(t)},sprites[e[s]]=n}},renderList=function(t){console.log("renderList");var e=canvas.getContext("2d"),i=dpi/600;canvas.width=4960*i,canvas.height=7016*i,e.fillStyle="#fff",e.fillRect(0,0,canvas.width,canvas.height),$.each(t,function(t,s){s.forEach(s=>{e.drawImage(sprites[t],s[2][0]*i,s[2][1]*i,s[2][2]*i,s[2][3]*i,s[0]*i,s[1]*i,s[2][2]*i,s[2][3]*i)})}),showList(canvas)},lists_count=0;$("#write").click(function(){lists_count++,isMobile&&$("body").addClass("loading"),$("#write").prop("disabled",!0),$(".clipboard").addClass("loading"),sendText(),2!=lists_count&&lists_count%3!=0||openPopup()}),$("#text").keydown(function(t){if(9===t.keyCode){var e=this.value,i=this.selectionStart,s=this.selectionEnd;return this.value=e.substring(0,i)+"\t"+e.substring(s),this.selectionStart=this.selectionEnd=i+1,!1}t.ctrlKey&&13==t.keyCode&&($("#write").prop("disabled",!0),$(".clipboard").addClass("loading"),sendText())});var showList=function(t){console.log("showList"),$("#list_img").attr("crossorigin","anonymous"),$("#list_img").attr("src",t.toDataURL()),$("#list").show(),$(".clipboard").removeClass("loading"),$("body").removeClass("loading"),$("#write").prop("disabled",!1)};$("#text").bind("keydown input propertychange",function(){""!==$("#text").val()?$("#write").show():$("#write").hide()}),$("#list").click(function(){isMobile&&$("#list").hide()});var openPopup=function(){$(".popup").fadeIn(200),$(".popup").slideDown(200,function(){$(".env_list").slideDown(800)})},closePopup=function(){$(".env_list").slideUp(400,function(){$(".popup").hide(0,function(){})})};$(".env_list_x, .popup").click(function(t){t.target===this&&closePopup()});